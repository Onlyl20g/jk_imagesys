<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>金科控股-影像系统</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../dependency/bootstrap4/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../dependency/css/shards.min.css">
    <link rel="stylesheet" href="../../dependency/css/shards-demo.css?v=1.1.0">
    <link href="../../ruoyi/css/ry-ui.css?v=3.4.0" rel="stylesheet"/>
</head>

<body style="overflow-y: hidden">
<div class="loader">
    <div class="page-loader"></div>
</div>

<!-- Floating Shards -->
<img src="../../dependency/images/demo/jinke_logo_dark.png" alt="Shard" class="shard">
<img src="../../dependency/images/demo/ico/pdf.png" alt="Shard" class="shard1">
<img src="../../dependency/images/demo/ico/ppt.png" alt="Shard" class="shard2">
<img src="../../dependency/images/demo/ico/doc.png" alt="Shard" class="shard3">
<img src="../../dependency/images/demo/ico/zip.png" alt="Shard" class="shard4">
<!--<img src="../../dependency/images/demo/ico/video.png" alt="Shard" class="shard5">-->
<img src="../../dependency/images/demo/ico/flash.png" alt="Shard" class="shard6">
<img src="../../dependency/images/demo/ico/xls.png" alt="Shard" class="shard7">
<img src="../../dependency/images/demo/ico/mp3.png" alt="Shard" class="shard8">

<!-- Welcome Section -->
<div class="welcome d-flex justify-content-center flex-column">
    <!--<div class="inner-wrapper mt-auto mb-auto">
        <h2 class="slide-in">影像系统</h2>
        &lt;!&ndash;<p class="slide-in">JINKE HOLDINGS IMAGE SYSTEM.</p>&ndash;&gt;
    </div>-->
    <div class="inner-wrapper mt-auto mb-auto" style="display: none;">
        <div class="action-links slide-in" id="showForm">
            <button type="button" class="btn btn-primary btn-pill btn-lg  d-table ml-auto mr-auto" data-toggle="modal"
                    data-target="#exampleModal" id="exampleBtn">
                登&nbsp;&nbsp;录
            </button>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="container">
    <form id="login">
        <div class="mb-5">
            <!-- Modal Body -->
            <div class="modal fade" id="exampleModal" data-backdrop="static" data-keyboard="false" tabindex="-1"
                 role="dialog" aria-labelledby="exampleModalLabel"
                 aria-hidden="false">
                <div class="modal-dialog" role="document" style="margin-top: 200px;">
                    <div>
                        <h2 style="text-align: center;margin-bottom: 32px;">影像系统</h2>
                    </div>
                    <div class="modal-content" style="background: rgba(253, 253, 253, 0.85)">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel"></h5>
                            <button type="button" class="close" hidden data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form class="form-horizontal">
                                <div class="row">
                                    <div class="form-group col-md-12">
                                        <div class="input-group with-addon-icon-left" style="">
                                                    <span class="input-group-addon">
                                                        👨‍
                                                    </span>
                                            <input type="text" name="loginName" class="form-control" id="loginName"
                                                   placeholder="请输入用户名">
                                        </div>
                                    </div>
                                    <div class="form-group col-md-12">
                                        <div class="input-group with-addon-icon-left" style="">
                                                    <span class="input-group-addon">
                                                        🔐
                                                    </span>
                                            <input type="password" name="password" class="form-control" id="password"
                                                   placeholder="请输入密码">
                                        </div>
                                    </div>
                                </div>
                            </form>

                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">登录</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal" hidden>取消</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<footer class="main-footer py-5">
    <p class="text-muted text-center small p-0 mb-4">&copy;2019 <a href="#">重庆市金科投资控股（集团）有限责任公司</a></p>
</footer>
</div>

<div id="change_pwd" class="container-fluid" style="overflow: hidden; display: none; color: black;">
    <form id="form_resetPwd">
        <div class="row" style="margin: 20px 0px 0px;">
            <div class="col-sm-3" align="right" style="line-height: 40px;height: 40px;">
                <label class="control-label">登录名称</label>
            </div>
            <div class="col-sm-8">
                <input class="form-control" type="text" readonly="true" name="loginName" id="login_name"/>
            </div>
        </div>
        <div class="row" style="margin: 20px 0px 0px;">
            <div class="col-sm-3" align="right" style="line-height: 40px;height: 40px;">
                <label class="control-label">新密码</label>
            </div>
            <div class="col-sm-8">
                <input class="form-control" value="" type="password" name="password" id="new_pwd">
            </div>
        </div>
        <div class="row" style="margin: 20px 0px 0px;">
            <div class="col-sm-3" align="right" style="line-height: 40px;height: 40px;">
                <label class="control-label">确认密码</label>
            </div>
            <div class="col-sm-8">
                <input class="form-control" value="" type="password" name="confirm_password" id="confirm_password">
            </div>
        </div>
    </form>
</div>
<div id="infoDiv" style="display: none;">

</div>

<!-- JavaScript -->
<script src="../dependency/js/buttons.js"></script>
<script src="../dependency/js/jquery-3.2.1.min.js"></script>
<script src="../dependency/js/popper.min.js"></script>
<script src="../dependency/bootstrap4/js/bootstrap.min.js"></script>
<script src="../dependency/js/shards.min.js"></script>
<script src="../dependency/js/demo.min.js"></script>
<script src="../ajax/libs/layer/layer.min.js"></script>
<script src="../ajax/libs/layui/layui.js"></script>
<script src="../ajax/libs/validate/jquery.validate.min.js"></script>
<script src="../ajax/libs/validate/messages_zh.min.js"></script>
<script type="application/javascript">
    if (self != top && top.controller) {
        window.top.location.href = "/system/login";
    }
    $(function () {
        window.history.forward(-1);
        validateRule();
        $("#showForm").click(function () {
            clear();
        });
        $("#exampleBtn")[0].click();
        if ($("#loginName").val() != "") {
            $("#password").focus();
        } else {
            $("#loginName").focus();
        }
    });

    function validateRule() {
        var icon = '<i class="fa fa-times-circle"></i> ';
        $("#login").validate({
            rules: {
                loginName: 'required',
                password: 'required'
            },
            messages: {
                loginName: {
                    required: icon + '请填写登陆账号'
                },
                password: {
                    required: icon + '请填写登陆密码'
                }
            },
            submitHandler: function () {
                login();
            }
        });

        $("#form_resetPwd").validate({
            rules: {
                password: {
                    required: true,
                    minlength: 8
                },
                confirm_password: {
                    required: true,
                    minlength: 8,
                    equalTo: "#new_pwd"
                }
            },
            messages: {
                password: {
                    required: icon + "请输入您的密码",
                    minlength: icon + "密码8个字符以上且由数字+字母或特殊字符组成"
                },
                confirm_password: {
                    required: icon + "请再次输入密码",
                    minlength: icon + "密码必须8个字符以上",
                    equalTo: icon + "两次输入的密码不一致"
                }
            },
            onsubmit: true,// 是否在提交时验证
            onfocusout: false,// 是否在获取焦点时验证
            onkeyup: false// 是否在敲击键盘时验证
        });
    }

    /**
     * 显示修改密码框
     */
    function showPwd() {
//        $('#').remove();
        $('#exampleModal').modal('hide');
        $("#login_name").val($("#loginName").val());
        layer.open({
            type: 1,
            title: '初次登陆-重设密码',
//            maxmin: true,
            shadeClose: false, //点击遮罩关闭层
            area: ['40%', '46%'],
            btn: ['确认', '取消'],
            content: $("#change_pwd"),
            yes: function () {
                var password = $("#new_pwd").val();
                if ($("#form_resetPwd").valid()) {
                    if (checkIntensity(password) < 2) {
                        showResult("密码强度过低,请重新设置", '关闭', 1);
                        return;
                    }
                    svaePwd();
                }
            }
        });
    }

    /**
     * 显示提示信息
     * @param content
     * @param type
     */
    var showResult = function (content, btn, closeBtn) {
        layer.open({
            title: '提示',
            btn: btn,
            closeBtn: closeBtn,
            content: content,
            success: function (layero, index) {
                this.enterConfirm = function (event) {
                    if (event.keyCode === 13) {
                        $(".layui-layer-btn0").click();
                        return false; //阻止系统默认回车事件
                    }
                };
                $(document).on('keydown', this.enterConfirm); //监听键盘事件
                // 点击确定按钮回调事件
                $(".layui-layer-btn0").on("click", function () {
                    layer.close(index);
                });
            },
            end: function () {
                $("#password").val("");
                $(document).off('keydown', this.enterConfirm); //解除键盘事件
            }
        });
    };

    /**
     * 登陆
     */
    function login() {
        sessionStorage.setItem("useFolders", "");
        sessionStorage.setItem("useFoledePaths", "根目录");
        var userUnable = "用户已封禁，请联系管理员";
        var userUnableReplace = "账号未激活,请联系相关客户经理";
        var userError = "用户不存在/密码错误";
        var userErrorReplace = "账号或密码有误,请检查后重试";
        $.ajax({
            url: '/system/loginUser',
            type: 'post',
            data: {'username': $("#loginName").val(), 'password': $("#password").val(), 'rememberMe': 'false'},
            dataType: 'json',
            success: function (r) {
                if (r.code == 0) {
                    checkFirstLogin()
//                    location.href = "main";
                } else {
                    if (r.msg == userUnable) {
                        r.msg = userUnableReplace;
                    } else if (r.msg == userError) {
                        r.msg = userErrorReplace;
                    }
                    showResult(r.msg, '关闭', 1);
                }
            }
        })
    }

    /**
     * 验证初次登陆
     */
    function checkFirstLogin() {
        $.ajax({
            url: '/system/checkFirstLogin',
            type: 'post',
            dataType: 'json',
            success: function (r) {
                if (r) {
                    localStorage.setItem("loginName", $("#loginName").val());
                    location.href = "main";
                } else {
                    showPwd();
                }
            }
        })
    }


    function svaePwd() {
        var loginName = $("#login_name").val();
        var password = $("#new_pwd").val();
        $.ajax({
            url: '/system/updatePwd',
            type: 'post',
            data: {"loginName": loginName, "password": password},
            dataType: 'json',
            success: function (r) {
                if (r) {
                    showResult("修改成功", '', 0);
                    setTimeout(function () {
                        location.href = "main";
                    }, 3000)
                }
            }
        })
    }

    /**
     * 检测密码强度
     */
    function checkIntensity(pwd) {
        var m = 0;
        var Modes = 0;
        for (i = 0; i < pwd.length; i++) {
            var charType = 0;
            var t = pwd.charCodeAt(i); //得出Unicode 编码编码，值越大，密码就越复杂
            if (t >= 48 && t <= 57) {
                charType = 1;
            } else if (t >= 65 && t <= 90) {
                charType = 2;
            } else if (t >= 97 && t <= 122) {
                charType = 4;
            } else {
                charType = 4;
            }
            Modes |= charType;
        }
        for (i = 0; i < 4; i++) {
            if (Modes & 1) m++;
            Modes >>>= 1;
        }
        if (pwd.length <= 4) {
            m = 1;
        }
        return m;
    }

    function clear() {
        $("#loginName").val(localStorage.getItem("loginName"));
        $("#password").val("");
    }

</script>

</body>

</html>
