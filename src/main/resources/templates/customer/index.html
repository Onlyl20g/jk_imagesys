<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>é‡‘ç§‘æ§è‚¡-å½±åƒç³»ç»Ÿ</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../dependency/bootstrap4/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../dependency/css/shards.min.css">
    <link rel="stylesheet" href="../../dependency/css/shards-demo.css?v=1.1.0">
    <link href="../../ruoyi/css/ry-ui.css?v=3.4.0" rel="stylesheet"/>
</head>

<body style="overflow-y: hidden">
<div class="loader">
    <div class="page-loader"></div>
</div>

<!-- Floating Shards -->
<img src="../../dependency/images/demo/jinke_logo_dark.png" alt="Shard" class="shard">
<img src="../../dependency/images/demo/ico/pdf.png" alt="Shard" class="shard1">
<img src="../../dependency/images/demo/ico/ppt.png" alt="Shard" class="shard2">
<img src="../../dependency/images/demo/ico/doc.png" alt="Shard" class="shard3">
<img src="../../dependency/images/demo/ico/zip.png" alt="Shard" class="shard4">
<!--<img src="../../dependency/images/demo/ico/video.png" alt="Shard" class="shard5">-->
<img src="../../dependency/images/demo/ico/flash.png" alt="Shard" class="shard6">
<img src="../../dependency/images/demo/ico/xls.png" alt="Shard" class="shard7">
<img src="../../dependency/images/demo/ico/mp3.png" alt="Shard" class="shard8">

<!-- Welcome Section -->
<div class="welcome d-flex justify-content-center flex-column">
    <!--<div class="inner-wrapper mt-auto mb-auto">
        <h2 class="slide-in">å½±åƒç³»ç»Ÿ</h2>
        &lt;!&ndash;<p class="slide-in">JINKE HOLDINGS IMAGE SYSTEM.</p>&ndash;&gt;
    </div>-->
    <div class="inner-wrapper mt-auto mb-auto" style="display: none;">
        <div class="action-links slide-in" id="showForm">
            <button type="button" class="btn btn-primary btn-pill btn-lg  d-table ml-auto mr-auto" data-toggle="modal"
                    data-target="#exampleModal" id="exampleBtn">
                ç™»&nbsp;&nbsp;å½•
            </button>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="container">
    <form id="login">
        <div class="mb-5">
            <!-- Modal Body -->
            <div class="modal fade" id="exampleModal" data-backdrop="static" data-keyboard="false" tabindex="-1"
                 role="dialog" aria-labelledby="exampleModalLabel"
                 aria-hidden="false">
                <div class="modal-dialog" role="document" style="margin-top: 200px;">
                    <div>
                        <h2 style="text-align: center;margin-bottom: 32px;">å½±åƒç³»ç»Ÿ</h2>
                    </div>
                    <div class="modal-content" style="background: rgba(253, 253, 253, 0.85)">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel"></h5>
                            <button type="button" class="close" hidden data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form class="form-horizontal">
                                <div class="row">
                                    <div class="form-group col-md-12">
                                        <div class="input-group with-addon-icon-left" style="">
                                                    <span class="input-group-addon">
                                                        ğŸ‘¨â€
                                                    </span>
                                            <input type="text" name="loginName" class="form-control" id="loginName"
                                                   placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                                        </div>
                                    </div>
                                    <div class="form-group col-md-12">
                                        <div class="input-group with-addon-icon-left" style="">
                                                    <span class="input-group-addon">
                                                        ğŸ”
                                                    </span>
                                            <input type="password" name="password" class="form-control" id="password"
                                                   placeholder="è¯·è¾“å…¥å¯†ç ">
                                        </div>
                                    </div>
                                </div>
                            </form>

                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">ç™»å½•</button>
                            <button type="button" class="btn btn-default" data-dismiss="modal" hidden>å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<footer class="main-footer py-5">
    <p class="text-muted text-center small p-0 mb-4">&copy;2019 <a href="#">é‡åº†å¸‚é‡‘ç§‘æŠ•èµ„æ§è‚¡ï¼ˆé›†å›¢ï¼‰æœ‰é™è´£ä»»å…¬å¸</a></p>
</footer>
</div>

<div id="change_pwd" class="container-fluid" style="overflow: hidden; display: none; color: black;">
    <form id="form_resetPwd">
        <div class="row" style="margin: 20px 0px 0px;">
            <div class="col-sm-3" align="right" style="line-height: 40px;height: 40px;">
                <label class="control-label">ç™»å½•åç§°</label>
            </div>
            <div class="col-sm-8">
                <input class="form-control" type="text" readonly="true" name="loginName" id="login_name"/>
            </div>
        </div>
        <div class="row" style="margin: 20px 0px 0px;">
            <div class="col-sm-3" align="right" style="line-height: 40px;height: 40px;">
                <label class="control-label">æ–°å¯†ç </label>
            </div>
            <div class="col-sm-8">
                <input class="form-control" value="" type="password" name="password" id="new_pwd">
            </div>
        </div>
        <div class="row" style="margin: 20px 0px 0px;">
            <div class="col-sm-3" align="right" style="line-height: 40px;height: 40px;">
                <label class="control-label">ç¡®è®¤å¯†ç </label>
            </div>
            <div class="col-sm-8">
                <input class="form-control" value="" type="password" name="confirm_password" id="confirm_password">
            </div>
        </div>
    </form>
</div>
<div id="infoDiv" style="display: none;">

</div>

<!-- JavaScript -->
<script src="../dependency/js/buttons.js"></script>
<script src="../dependency/js/jquery-3.2.1.min.js"></script>
<script src="../dependency/js/popper.min.js"></script>
<script src="../dependency/bootstrap4/js/bootstrap.min.js"></script>
<script src="../dependency/js/shards.min.js"></script>
<script src="../dependency/js/demo.min.js"></script>
<script src="../ajax/libs/layer/layer.min.js"></script>
<script src="../ajax/libs/layui/layui.js"></script>
<script src="../ajax/libs/validate/jquery.validate.min.js"></script>
<script src="../ajax/libs/validate/messages_zh.min.js"></script>
<script type="application/javascript">
    if (self != top && top.controller) {
        window.top.location.href = "/system/login";
    }
    $(function () {
        window.history.forward(-1);
        validateRule();
        $("#showForm").click(function () {
            clear();
        });
        $("#exampleBtn")[0].click();
        if ($("#loginName").val() != "") {
            $("#password").focus();
        } else {
            $("#loginName").focus();
        }
    });

    function validateRule() {
        var icon = '<i class="fa fa-times-circle"></i> ';
        $("#login").validate({
            rules: {
                loginName: 'required',
                password: 'required'
            },
            messages: {
                loginName: {
                    required: icon + 'è¯·å¡«å†™ç™»é™†è´¦å·'
                },
                password: {
                    required: icon + 'è¯·å¡«å†™ç™»é™†å¯†ç '
                }
            },
            submitHandler: function () {
                login();
            }
        });

        $("#form_resetPwd").validate({
            rules: {
                password: {
                    required: true,
                    minlength: 8
                },
                confirm_password: {
                    required: true,
                    minlength: 8,
                    equalTo: "#new_pwd"
                }
            },
            messages: {
                password: {
                    required: icon + "è¯·è¾“å…¥æ‚¨çš„å¯†ç ",
                    minlength: icon + "å¯†ç 8ä¸ªå­—ç¬¦ä»¥ä¸Šä¸”ç”±æ•°å­—+å­—æ¯æˆ–ç‰¹æ®Šå­—ç¬¦ç»„æˆ"
                },
                confirm_password: {
                    required: icon + "è¯·å†æ¬¡è¾“å…¥å¯†ç ",
                    minlength: icon + "å¯†ç å¿…é¡»8ä¸ªå­—ç¬¦ä»¥ä¸Š",
                    equalTo: icon + "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´"
                }
            },
            onsubmit: true,// æ˜¯å¦åœ¨æäº¤æ—¶éªŒè¯
            onfocusout: false,// æ˜¯å¦åœ¨è·å–ç„¦ç‚¹æ—¶éªŒè¯
            onkeyup: false// æ˜¯å¦åœ¨æ•²å‡»é”®ç›˜æ—¶éªŒè¯
        });
    }

    /**
     * æ˜¾ç¤ºä¿®æ”¹å¯†ç æ¡†
     */
    function showPwd() {
//        $('#').remove();
        $('#exampleModal').modal('hide');
        $("#login_name").val($("#loginName").val());
        layer.open({
            type: 1,
            title: 'åˆæ¬¡ç™»é™†-é‡è®¾å¯†ç ',
//            maxmin: true,
            shadeClose: false, //ç‚¹å‡»é®ç½©å…³é—­å±‚
            area: ['40%', '46%'],
            btn: ['ç¡®è®¤', 'å–æ¶ˆ'],
            content: $("#change_pwd"),
            yes: function () {
                var password = $("#new_pwd").val();
                if ($("#form_resetPwd").valid()) {
                    if (checkIntensity(password) < 2) {
                        showResult("å¯†ç å¼ºåº¦è¿‡ä½,è¯·é‡æ–°è®¾ç½®", 'å…³é—­', 1);
                        return;
                    }
                    svaePwd();
                }
            }
        });
    }

    /**
     * æ˜¾ç¤ºæç¤ºä¿¡æ¯
     * @param content
     * @param type
     */
    var showResult = function (content, btn, closeBtn) {
        layer.open({
            title: 'æç¤º',
            btn: btn,
            closeBtn: closeBtn,
            content: content,
            success: function (layero, index) {
                this.enterConfirm = function (event) {
                    if (event.keyCode === 13) {
                        $(".layui-layer-btn0").click();
                        return false; //é˜»æ­¢ç³»ç»Ÿé»˜è®¤å›è½¦äº‹ä»¶
                    }
                };
                $(document).on('keydown', this.enterConfirm); //ç›‘å¬é”®ç›˜äº‹ä»¶
                // ç‚¹å‡»ç¡®å®šæŒ‰é’®å›è°ƒäº‹ä»¶
                $(".layui-layer-btn0").on("click", function () {
                    layer.close(index);
                });
            },
            end: function () {
                $("#password").val("");
                $(document).off('keydown', this.enterConfirm); //è§£é™¤é”®ç›˜äº‹ä»¶
            }
        });
    };

    /**
     * ç™»é™†
     */
    function login() {
        sessionStorage.setItem("useFolders", "");
        sessionStorage.setItem("useFoledePaths", "æ ¹ç›®å½•");
        var userUnable = "ç”¨æˆ·å·²å°ç¦ï¼Œè¯·è”ç³»ç®¡ç†å‘˜";
        var userUnableReplace = "è´¦å·æœªæ¿€æ´»,è¯·è”ç³»ç›¸å…³å®¢æˆ·ç»ç†";
        var userError = "ç”¨æˆ·ä¸å­˜åœ¨/å¯†ç é”™è¯¯";
        var userErrorReplace = "è´¦å·æˆ–å¯†ç æœ‰è¯¯,è¯·æ£€æŸ¥åé‡è¯•";
        $.ajax({
            url: '/system/loginUser',
            type: 'post',
            data: {'username': $("#loginName").val(), 'password': $("#password").val(), 'rememberMe': 'false'},
            dataType: 'json',
            success: function (r) {
                if (r.code == 0) {
                    checkFirstLogin()
//                    location.href = "main";
                } else {
                    if (r.msg == userUnable) {
                        r.msg = userUnableReplace;
                    } else if (r.msg == userError) {
                        r.msg = userErrorReplace;
                    }
                    showResult(r.msg, 'å…³é—­', 1);
                }
            }
        })
    }

    /**
     * éªŒè¯åˆæ¬¡ç™»é™†
     */
    function checkFirstLogin() {
        $.ajax({
            url: '/system/checkFirstLogin',
            type: 'post',
            dataType: 'json',
            success: function (r) {
                if (r) {
                    localStorage.setItem("loginName", $("#loginName").val());
                    location.href = "main";
                } else {
                    showPwd();
                }
            }
        })
    }


    function svaePwd() {
        var loginName = $("#login_name").val();
        var password = $("#new_pwd").val();
        $.ajax({
            url: '/system/updatePwd',
            type: 'post',
            data: {"loginName": loginName, "password": password},
            dataType: 'json',
            success: function (r) {
                if (r) {
                    showResult("ä¿®æ”¹æˆåŠŸ", '', 0);
                    setTimeout(function () {
                        location.href = "main";
                    }, 3000)
                }
            }
        })
    }

    /**
     * æ£€æµ‹å¯†ç å¼ºåº¦
     */
    function checkIntensity(pwd) {
        var m = 0;
        var Modes = 0;
        for (i = 0; i < pwd.length; i++) {
            var charType = 0;
            var t = pwd.charCodeAt(i); //å¾—å‡ºUnicode ç¼–ç ç¼–ç ï¼Œå€¼è¶Šå¤§ï¼Œå¯†ç å°±è¶Šå¤æ‚
            if (t >= 48 && t <= 57) {
                charType = 1;
            } else if (t >= 65 && t <= 90) {
                charType = 2;
            } else if (t >= 97 && t <= 122) {
                charType = 4;
            } else {
                charType = 4;
            }
            Modes |= charType;
        }
        for (i = 0; i < 4; i++) {
            if (Modes & 1) m++;
            Modes >>>= 1;
        }
        if (pwd.length <= 4) {
            m = 1;
        }
        return m;
    }

    function clear() {
        $("#loginName").val(localStorage.getItem("loginName"));
        $("#password").val("");
    }

</script>

</body>

</html>
